version: "3.8"

# ============================================================
# Self-Managed Kafka Connect - 실제 Aurora MySQL + MSK 연결
#
# TLS 1.3 관련 테스트:
#   - use.nongraceful.disconnect 옵션
#   - TLS 1.2 강제 사용 (JVM 옵션)
# ============================================================

services:
  kafka-connect:
    image: quay.io/debezium/connect:2.7
    container_name: self-managed-connect
    environment:
      GROUP_ID: self-managed-cdc
      BOOTSTRAP_SERVERS: b-1.your-msk-cluster.xxxxxx.c3.kafka.ap-northeast-2.amazonaws.com:9092,b-2.your-msk-cluster.xxxxxx.c3.kafka.ap-northeast-2.amazonaws.com:9092
      CONFIG_STORAGE_TOPIC: self-managed-connect-configs
      OFFSET_STORAGE_TOPIC: self-managed-connect-offsets
      STATUS_STORAGE_TOPIC: self-managed-connect-status
      CONFIG_STORAGE_REPLICATION_FACTOR: 2
      OFFSET_STORAGE_REPLICATION_FACTOR: 2
      STATUS_STORAGE_REPLICATION_FACTOR: 2
      # TLS 1.2 강제 사용 (TLS 1.3 이슈 해결)
      KAFKA_OPTS: "-Djdk.tls.client.protocols=TLSv1.2"
    ports:
      - "8083:8083"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8083/ || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
